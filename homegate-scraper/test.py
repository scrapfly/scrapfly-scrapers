import json
import os
from pathlib import Path
from cerberus import Validator
import homegate
import pytest
import pprint

pp = pprint.PrettyPrinter(indent=4)

# enable scrapfly cache
homegate.BASE_CONFIG["cache"] = os.getenv("SCRAPFLY_CACHE") == "true"


def validate_or_fail(item, validator):
    if not validator.validate(item):
        pp.pformat(item)
        pytest.fail(
            f"Validation failed for item: {pp.pformat(item)}\nErrors: {validator.errors}"
        )


property_schema = {
    "schema": {
        "type": "dict",
        "schema": {
            "localization": {
                "type": "dict",
                "schema": {
                    "de": {
                        "type": "dict",
                        "schema": {
                            "text": {
                                "type": "dict",
                                "schema": {
                                    "title": {"type": "string"},
                                    "description": {"type": "string"},
                                },
                            },
                            "attachments": {
                                "type": "list",
                                "schema": {
                                    "type": "dict",
                                    "schema": {
                                        "type": {"type": "string"},
                                        "url": {"type": "string"},
                                        "file": {"type": "string"},
                                    },
                                },
                            },
                        },
                    },
                    "primary": {"type": "string"},
                },
            },
            "lister": {
                "type": "dict",
                "schema": {
                    "primary": {"type": "string"},
                    "website": {
                        "type": "dict",
                        "schema": {"value": {"type": "string"}},
                    },
                    "id": {"type": "string"},
                    "allowToContact": {"type": "boolean", "nullable": True},
                },
            },
            "characteristics": {
                "type": "dict",
                "schema": {
                    "livingSpace": {"type": "integer"},
                    "numberOfRooms": {"type": "integer"},
                },
            },
            "address": {
                "type": "dict",
                "schema": {
                    "country": {"type": "string"},
                    "geoDistances": {
                        "type": "list",
                        "schema": {
                            "type": "dict",
                            "schema": {
                                "distance": {"type": "integer"},
                                "geoTag": {"type": "string"},
                            },
                        },
                    },
                    "geoTags": {
                        "type": "list",
                        "schema": {"type": "string"},
                    },
                    "street": {"type": "string"},
                    "postalCode": {"type": "string"},
                    "locality": {"type": "string"},
                    "geoCoordinates": {
                        "schema": {
                            "type": "dict",
                            "schema": {
                                "accuracy": {"type": "string"},
                                "manual": {"type": "boolean"},
                                "latitude": {"type": "integer", "nullable": True},
                                "longitude": {"type": "integer", "nullable": True},
                            },
                        }
                    },
                },
            },
            "externalIds": {
                "type": "dict",
                "schema": {
                    "internalReferenceId": {"type": "string"},
                    "displayReferenceId": {"type": "string"},
                    "refObject": {"type": "string"},
                    "displayPropertyReferenceId": {"type": "string"},
                    "propertyReferenceId": {"type": "string"},
                },
            },
            "contactForm": {
                "type": "dict",
                "schema": {
                    "size": {"type": "string"},
                    "deliveryFormat": {"type": "string"},
                },
            },
            "version": {"type": "string"},
            "platform": {"type": "list", "schema": {"type": "string"}},
            "offerType": {"type": "string"},
            "meta": {
                "type": "dict",
                "schema": {
                    "createdAt": {"type": "string"},
                    "updatedAt": {"type": "string"},
                    "source": {"type": "string"},
                },
            },
            "id": {"type": "string"},
            "categories": {"type": "list", "schema": {"type": "string"}},
            "prices": {
                "type": "dict",
                "schema": {
                    "rent": {
                        "type": "dict",
                        "schema": {
                            "area": {"type": "string"},
                            "interval": {"type": "string"},
                            "net": {"type": "integer"},
                            "gross": {"type": "integer"},
                        },
                    },
                    "currency": {"type": "string"},
                },
            },
            "valueAddedServices": {
                "type": "dict",
                "schema": {"isTenantPlusListing": {"type": "boolean"}},
            },
        },
    },
}

search_schema = {
    "schema": {
        "type": "dict",
        "schema": {
            "listingType": {
                "type": "dict",
                "schema": {
                    "type": {"type": "string"},
                },
            },
            "listing": {
                "type": "dict",
                "schema": {
                    "address": {
                        "type": "dict",
                        "schema": {
                            "geoCoordinates": {
                                "type": "dict",
                                "schema": {
                                    "accuracy": {"type": "string"},
                                    "manual": {"type": "boolean"},
                                    "latitude": {"type": "integer", "nullable": True},
                                    "longitude": {"type": "integer", "nullable": True},
                                },
                            },
                            "locality": {"type": "string"},
                            "postalCode": {"type": "string"},
                            "street": {"type": "string"},
                        },
                    },
                    "categories": {"type": "list", "schema": {"type": "string"}},
                    "characteristics": {
                        "type": "dict",
                        "schema": {
                            "hasNiceView": {"type": "boolean"},
                            "hasBalcony": {"type": "boolean"},
                            "hasElevator": {"type": "boolean"},
                            "livingSpace": {"type": "integer"},
                            "numberOfRooms": {"type": "integer"},
                            "floor": {"type": "integer"},
                            "isQuiet": {"type": "boolean"},
                            "yearBuilt": {"type": "integer"},
                            "hasGarage": {"type": "boolean"},
                        },
                    },
                    "id": {"type": "string"},
                    "localization": {
                        "type": "dict",
                        "schema": {
                            "de": {
                                "schema": {
                                    "text": {
                                        "type": "dict",
                                        "schema": {
                                            "title": {"type": "string"},
                                            "description": {"type": "string"},
                                        },
                                    },
                                    "attachments": {
                                        "type": "list",
                                        "schema": {
                                            "type": "dict",
                                            "schema": {
                                                "type": {"type": "string"},
                                                "url": {"type": "string"},
                                                "file": {"type": "string"},
                                            },
                                        },
                                    },
                                }
                            },
                            "primary": {"type": "string"},
                        },
                    },
                    "meta": {
                        "type": "dict",
                        "schema": {
                            "createdAt": {"type": "string"},
                        },
                    },
                    "offerType": {"type": "string"},
                    "platforms": {"type": "string"},
                    "prices": {
                        "type": "dict",
                        "schema": {
                            "rent": {
                                "type": "dict",
                                "schema": {
                                    "interval": {"type": "string"},
                                    "gross": {"type": "integer"},
                                },
                            },
                            "currency": {"type": "integer"},
                        },
                    },
                },
            },
            "listingCard": {
                "type": "dict",
                "schema": {
                    "size": {"type": "string"},
                },
            },
            "id": {"type": "string"},
        },
    }
}


@pytest.mark.asyncio
async def test_properties_scraping():
    result = await homegate.scrape_properties(
        urls=[
            "https://www.homegate.ch/rent/4002086534",
            "https://www.homegate.ch/rent/4002475362",
            "https://www.homegate.ch/rent/4002086532",
        ]
    )
    validator = Validator(property_schema, allow_unknown=True)
    for item in result:
        validate_or_fail(item, validator)
    assert len(result) >= 1
    if os.getenv("SAVE_TEST_RESULTS") == "true":
        result.sort(key=lambda x: x["id"])
        (Path(__file__).parent / 'results/properties.json').write_text(
            json.dumps(result, indent=2, ensure_ascii=False, default=str)
        )


@pytest.mark.asyncio
async def test_search_scraping():
    result = await homegate.scrape_search(
        url="https://www.homegate.ch/rent/real-estate/city-bern/matching-list",
        scrape_all_pages=False,
        max_scrape_pages=2,
    )
    validator = Validator(search_schema, allow_unknown=True)
    for item in result:
        validate_or_fail(item, validator)
    assert len(result) >= 2
    if os.getenv("SAVE_TEST_RESULTS") == "true":
        result.sort(key=lambda x: x["id"])
        (Path(__file__).parent / 'results/search.json').write_text(
            json.dumps(result, indent=2, ensure_ascii=False, default=str)
        )
